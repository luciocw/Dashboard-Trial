<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Dynasty Dashboard - Teste Real</title>
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root{--bg-primary:#1a1d21;--bg-secondary:#23272e;--bg-card:#2a2f38;--text-primary:#e8eaed;--accent:#5c9eff;--dynasty:#a185f7;--success:#34a853;--border:#3c4149;}
        body{font-family:sans-serif;background:var(--bg-primary);color:var(--text-primary);margin:0;padding:20px;}
        header{display:flex;justify-content:space-between;align-items:center;padding-bottom:20px;border-bottom:1px solid var(--border)}
        .leagues-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px;margin-top:20px}
        .league-card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:10px;padding:15px}
        .player-row{font-size:0.8rem;padding:3px;background:var(--bg-card);margin:2px;border-radius:3px;display:flex;justify-content:space-between}
        .btn-pro{background:linear-gradient(135deg, var(--dynasty), var(--accent));color:white;border:none;padding:10px 20px;border-radius:8px;font-weight:bold;cursor:pointer}
        .loading{text-align:center;padding:50px}
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">Iniciando Dashboard Real...</div>
    </div>

    <script>
        // 1. INICIALIZA√á√ÉO DO BANCO DE DADOS (PONTE PARA O PRO.HTML)
        const db = new Dexie('FantasyAuditorDB');
        db.version(1).stores({ stats: 'id' });

        const API = 'https://api.sleeper.app/v1';
        let players = {}, user = null, leagues = [];

        function openProView() { window.open('pro.html', '_blank'); }

        // 2. SINCRONIZA√á√ÉO COM O MODO PRO
        async function syncWithPro(data) {
            await db.stats.put({ 
                id: 'current_leagues', 
                payload: data, 
                user: user.display_name,
                timestamp: Date.now() 
            });
            console.log("Dados reais sincronizados para o Modo Pro!");
        }

        // 3. L√ìGICA DE BUSCA REAL (IGUAL AO SEU ORIGINAL)
        async function loadData() {
            try {
                // Busca Usu√°rio (Tenta o salvo ou pede novo)
                let saved = localStorage.getItem('dynasty_user');
                if(!saved) {
                    const username = prompt("Digite seu Username do Sleeper para o teste:");
                    const userRes = await fetch(`${API}/user/${username}`);
                    user = await userRes.json();
                    localStorage.setItem('dynasty_user', JSON.stringify(user));
                } else { user = JSON.parse(saved); }

                document.getElementById('app').innerHTML = `<div class="loading">Carregando seus jogadores de 2025...</div>`;

                // Busca Jogadores NFL (Carga Pesada)
                const pRes = await fetch(`${API}/players/nfl`);
                players = await pRes.json();

                // Busca Ligas do Usu√°rio
                const lRes = await fetch(`${API}/user/${user.user_id}/leagues/nfl/2025`);
                leagues = await lRes.json();

                // Busca Detalhes de cada liga (Rosters)
                for(let l of leagues) {
                    const rRes = await fetch(`${API}/league/${l.league_id}/rosters`);
                    const rosters = await rRes.json();
                    l.myRoster = rosters.find(r => r.owner_id === user.user_id);
                }

                // ENVIA OS DADOS REAIS PARA O BANCO
                await syncWithPro(leagues);
                render();

            } catch (e) {
                alert("Erro ao carregar dados: " + e.message);
            }
        }

        // 4. RENDERIZA√á√ÉO NA TELA
        function render() {
            document.getElementById('app').innerHTML = `
                <header>
                    <div>
                        <h2>üèà Dashboard Real: ${user.display_name}</h2>
                        <small>Dados sincronizados com o Banco de Dados local</small>
                    </div>
                    <button class="btn-pro" onclick="openProView()">‚ú® ABRIR MODO PRO</button>
                </header>
                <div class="leagues-grid">
                    ${leagues.map(l => `
                        <div class="league-card">
                            <h3>${l.name}</h3>
                            <div style="border-top:1px solid #3c4149; padding-top:10px">
                                ${l.myRoster ? (l.myRoster.players || []).slice(0,10).map(id => `
                                    <div class="player-row">
                                        <span>${players[id]?.full_name || 'Desconhecido'}</span>
                                        <b style="color:var(--accent)">${players[id]?.position || '?'}</b>
                                    </div>
                                `).join('') : 'Roster n√£o encontrado'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        loadData();
    </script>
</body>
</html>
